
---
title: "Mapping"
author: "Gabriel Prunier-Duparge"
date: "3 décembre 2018"
output: html_document
---

```{r}
#install.packages("leaflet")
#install.packages("sp")
```

```{r, message = FALSE}
library(leaflet)
library(maps)
library(rgdal)
library(sp)
library(tidyverse)
library(readr)
```

```{r}

m <- leaflet() %>%
  addTiles() %>%
  addMarkers(lng=174.768, lat=-36.852, popup="The birthplace of R")
m 

```


```{r}
df = data.frame(Lat = 30:40, Long = rnorm(11))
leaflet(df) %>% addCircles() %>% addTiles()
```

```{r}

mapStates = map("france", fill = TRUE, plot = FALSE)
leaflet(data = mapStates) %>% addTiles() %>%
  addPolygons(fillColor = topo.colors(10, alpha = NULL), stroke = FALSE)

```


```{r}
#Tentative de mettre les shapes de département

departments_shp <- readOGR( dsn=getwd(),
  layer = "departements-20180101")

#head(departments_shp)
#summary(departments_shp)
View(departments_shp)

departments_shp@data
```


```{r}
leaflet(data = departments_shp) %>% 
  addTiles() %>% 
  setView(lat = 48.5, lng = 2.5, zoom = 5) %>% 
  addPolygons(fillColor = "blue", 
              highlight = highlightOptions(color = "red", bringToFront = TRUE), label=~nom)
```

```{r}
#Travail sur l'élimination de variables et compagnies

#Création d'une variable de travail
departements_test <- departments_shp
departements_test@data

# departements_test@data <- departements_test@data %>% 
#   filter(code_insee == "75")
# 
# leaflet(data = departements_test) %>% 
#   addTiles() %>% 
#   setView(lat = 48.5, lng = 2.5, zoom = 5) %>% 
#   addPolygons(fillColor = "blue", 
#               highlight = highlightOptions(color = "red", bringToFront = TRUE), label=~nom)

departements_test_sub <- departements_test[departements_test$code_insee == "87",]

leaflet(data = departements_test_sub) %>% 
  addTiles() %>%
  setView(lat = 48.5, lng = 2.5, zoom = 5) %>%
  addPolygons(fillColor = "blue",
              highlight = highlightOptions(color = "red", bringToFront = TRUE), label=~nom)

```

```{r}
#Let's get rid of overseas department

departements_test <- departements_test[!departements_test$code_insee %in%c("971", "972", "973", "974", "975", "976", "69M"),]
departements_test@data


leaflet(data = departements_test) %>% 
  addTiles() %>%
  setView(lat = 48.5, lng = 2.5, zoom = 5) %>%
  addPolygons(fillColor = "blue",
              highlight = highlightOptions(color = "red", bringToFront = TRUE), label=~nom)

```


```{r}
dep_light <- readOGR(dsn = "departements-20140306-100m-shp", layer = "departements-20140306-100m")

leaflet(data = dep_light) %>% 
  addTiles() %>% 
  setView(lat = 47.5, lng = 2.5, zoom = 6) %>% 
  addPolygons(fillColor = "green", highlight = highlightOptions(color = "red", bringToFront = TRUE), label = ~nom)

```

```{r}
dep_light <- dep_light[!dep_light$code_insee %in%c("971", "972", "973", "974", "976"),]
dep_light@data

```



```{r}
rail_72 <- readOGR(dsn = "departement-72", layer = "railways")
points_72 <- readOGR(dsn = "departement-72", layer = "points")

points_72_H <- points_72[points_72$type == "hospital",]

leaflet(data=points_72_H) %>% 
  addTiles() %>% 
  setView(lat=47.5, lng = 2.5, zoom = 8) %>% 
  addCircleMarkers(label = ~type)


points_72@data %>% 
  group_by(points_72$type) %>% 
  summarise(tot = n())
```





Ok on commence le boulot d'écrire des fonctions et de faire de la prédiction

```{r}
equipment <- read.csv("Data/equipment.csv")

```


```{r}
dim(equipment)
summary(equipment)
head(equipment)
View(equipment)
names(equipment)
```

```{r}
pauvrete <- read_excel("Data/niveau_vie_dep.xlsx")
summary(pauvrete)
```

```{r}
library(FactoMineR)
```

```{r}
niveau_vie <- pauvrete %>% 
  select(niveau_de_vie_median)
niveau_vie


df_travail <- equipment %>% 
  mutate(niv_vie = niveau_vie$niveau_de_vie_median)
df_travail

df_travail <- df_travail %>% 
  select(dep, Etablissement.sante.court.sejour, Etablissement.sante.moyen.sejour, Etablissement.sante.long.sejour)

```

```{r}
res.pca <- PCA(df_travail, scale.unit = TRUE, quali.sup = 1)
```

```{r}
library(stringr)
```


```{r}
dep_depense <- read_excel("Data/cgd_2017 (3).xlsx", 
    sheet = "T01")

dep_depense <- dep_depense[-c(1:5),]
dep_depense <- dep_depense[-c(97:106),]

dep_depense <- dep_depense[, c(1,2)]
names(dep_depense) <- c("departement", "depense")

dep_depense <- dep_depense %>% 
  mutate(code_insee = substring(departement, 1, 2)) %>% 
  mutate(nom = str_sub(departement, 4))

dep_depense <- dep_depense[, c(3, 4, 2)]

View(dep_depense)


```

```{r}
df_travail2 <- df_travail %>% 
  mutate(depense = as.numeric(dep_depense$depense))
df_travail2

res.pca <- PCA(df_travail2, scale.unit = TRUE, quali.sup = 2, quanti.sup = c(1, 3:19, 21, 23))

```


```{r}
dep_education <- read.csv("Data/dep_education.csv")
```


```{r}
dep_edu <- read.csv("Data/dep_edu.csv")

df_edu <- equipment

categories_edu <- dep_edu %>%
  distinct(nature_uai_libe)
categories_edu

ajout_edu = function(df, catego){
  
}

df_edu <- dep_edu %>%
  mutate(college = (dep_edu %>% 
                      group_by(dpt) %>% 
                      filter(nature_uai_libe == "Collège") %>% 
                      summarise(college_tot = n()) %>% 
                      select(college_tot)))


education_par_dep <- dep_edu %>% 
  group_by(dpt) %>%
  filter(nature_uai_libe == "Collège") %>% 
  summarise(college = n())

education_par_dep <- education_par_dep %>% 
  mutate( dep_edu)

prendre_colonne = function(df, nom){
  nom <- enquo(nom)
  return(df %>% 
           group_by(df$dpt) %>%
           filter(df$nature_uai_libe == !!name) %>% 
           summarise(!!name = n()))
  }


```



